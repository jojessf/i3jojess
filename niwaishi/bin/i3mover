#!/usr/bin/perl
# JAF 20250908

use Getopt::Lazier;
my ($opt,@DARG) = Getopt::Lazier->new(@ARGV);

open IF, "<".$ENV{HOME}."/.config/i3/config";
LI: while (<IF>) {
  next LI if m/^\s*#/;
  next LI if ! m/set..mondo/;
  s/^set..//;
  my @yarg = split(" ", $_);
  $opt->{$yarg[0]} = $yarg[1];
}
close IF;

$opt->{dev} //= $opt->{mondol} if $opt->{l};
$opt->{dev} //= $opt->{mondor} if $opt->{r};
$opt->{dev} //= $opt->{mondoc} if $opt->{c};
$opt->{dev} //= $opt->{mondoc};


$opt->{othermon} = $dor if $opt->{dev} !~ /$dor/;
$opt->{othermon} = $dol if $opt->{dev} =~ /$dor/;

$opt->{w}    //= "1-20";  # workspaces to move;  e.g.: -r=1,5,7-10 # defaults to 1 through 20
$opt->{tempmode} //= 3;
$opt->{exec} //= 1;
$opt->{sleepyexec} //= 100;
$opt->{sleepyexec}   = $opt->{sleepyexec} / 1000;
$opt->{v}    //= 0;

$opt->{wcom} //= "i3-msg \"workspace WID\"";
$opt->{mcom} //= "i3-msg \"move workspace to output ".$opt->{dev}."\"";
$opt->{rcom} //= "i3-msg \"rename workspace WID to tWID\"";
$opt->{rrcom} //= "i3-msg \"rename workspace tWID to WID\"";

my @workspaces = ();

my @ws0 = split(",", $opt->{w});
foreach my $ws1 (@ws0) {
   my @range = split("-", $ws1);
   $range[1] //= $range[0];
   for (my $i=$range[0];$i<=$range[1];$i++) {
      push(@workspaces, $i);
   }
}

if ( $opt->{tall} ) {
   allmontmp();
   exit;
}


allmontmp() if $opt->{tempmode} && $opt->{tempmode} >= 2;

foreach my $ws (@workspaces) {
   print "[SELECT] ws# " . $ws . "\n" if $opt->{v} and $opt->{v} > 1;
   
   # (select) workspace WWW
   my $wcom = $opt->{wcom};
   $wcom =~ s/WID/$ws/g;
   print "[WCOM] $wcom\n" if $opt->{v};
   my $twcom = `$wcom` if $opt->{exec};
   select(undef,undef,undef,$opt->{sleepyexec}) if $opt->{sleepyexec};
   print $twcom if $opt->{v} and $opt->{v} > 1;
   
   # move container to output ZZZ
   my $mcom = $opt->{mcom};
   print "[MCOM] $mcom\n" if $opt->{v};
   my $tmcom = `$mcom` if $opt->{exec};
   select(undef,undef,undef,$opt->{sleepyexec}) if $opt->{sleepyexec};
   print $tmcom if $opt->{v} and $opt->{v} > 1;

   if ( $opt->{tempmode} ) {
      # (ToTEMP) 1-20 => t1-t20
      my $rcom = $opt->{rcom};
      $rcom =~ s/WID/$ws/g;
      my $trcom = `$rcom` if $opt->{exec};
      print "[RCOM] $rcom\n" if $opt->{v};
      print $trcom if $opt->{v} and $opt->{v} > 1;

  }
}

if ( $opt->{tempmode} ) {
   foreach my $ws (@workspaces) {
      # (select)  workspace tWWW
      my $wcom = $opt->{wcom};
      $wcom =~ s/WID/t$ws/g;
      print "[WCOM] $wcom\n" if $opt->{v};
      my $twcom = `$wcom` if $opt->{exec};
      print $twcom if $opt->{v} and $opt->{v} > 1;

      # (UNTEMP) t1-20 => 1-20     
      my $rrcom = $opt->{rrcom};
      $rrcom =~ s/WID/$ws/g;
      my $trrcom = `$rrcom` if $opt->{exec};
      print "[RRCOM] $rrcom\n" if $opt->{v};
      print $trrcom if $opt->{v} and $opt->{v} > 1;
   }
   allmontmp() if $opt->{tempmode} >= 3;
}


sub docom {
   my $docom = shift;
   if ( $docom =~ s/^noti3:?// ) {
      system($docom);
      return;
   } else {
      $docom = "i3-msg \"$docom\"";
      print "[DOCOM] $docom\n" if $opt->{v};
      my $dwcom = `$docom` if $opt->{exec};
      select(undef,undef,undef,$opt->{sleepyexec}) if $opt->{sleepyexec};
      print $dwcom if $opt->{v} and $opt->{v} > 1;
      return;
   } 
}

sub allmontmp {
   EACHMON: foreach my $mna (grep /mondo/, sort keys %{$opt}) {
      my $mon = $opt->{$mna};
      next EACHMON if ! $mon; 
      my $sfx = substr($mna, -1);
      docom("workspace z$sfx");
      docom("noti3:xterm &") if ! $opt->{allmontmpq};
      docom("move workspace to output $mon");
   }
   $opt->{allmontmpq}++;
   system("killall -15 xterm") if $opt->{allmontmpq} > 1;
}


