#!/usr/bin/perl
# JAF 20250908
use Getopt::Lazier;
my ($opt,@DARG) = Getopt::Lazier->new(@ARGV);
darguser(\@DARG,$opt);

i3monz(); # pull special $mondo[crl] vars from i3 config - these id monitors as left/right/center

# --------------------------------------------------------------------------- #
my $mn = "i3mv";
my $USAGE = <<EOUSE;
   i3mv: a lazy script for shuffling workspaces in i3
   $mn -w=6,11-15 -l     # move workspaces 6 & 11 through 15 to left monitor
   $mn w3                # move workspace 3 to default monitor
   $mn r                 # move ws 1-20 to r mon
EOUSE
if ( $opt->{h} ) { print $USAGE; exit; }
# --------------------------------------------------------------------------- #

$opt->{w}    //= "1-20";  # workspaces to move;  e.g.: -r=1,5,7-10 # defaults to 1 through 20
$opt->{exec} //= 1; # actually do stuff uWu 
$opt->{sleepyexec} //= 10; # ms between ops 
$opt->{sleepyexec}  /= 1000;

$opt->{wcom} //=  "workspace WID";
$opt->{mcom} //=  "move workspace to output ".$opt->{dev}."";
$opt->{rcom} //=  "rename workspace WID to tWID";
$opt->{rrcom} //= "rename workspace tWID to WID";


# --------------------------------------------------------------------------- #

my @workspaces = ();
my @ws0 = split(",", $opt->{w});
$opt->{tempmode} //= 4;
$opt->{tempmode} =~ s/4/3/ if scalar(@ws0)>1; # default to excessive temp workspace shenanigans
$opt->{tempmode} =~ s/4/1/ if scalar(@ws0)==1; # just single tempmode ... 

foreach my $ws1 (@ws0) {
   my @range = split("-", $ws1);
   $range[1] //= $range[0];
   for (my $i=$range[0];$i<=$range[1];$i++) {
      push(@workspaces, $i);
   }
}

allmontmp() if $opt->{tempmode} && $opt->{tempmode} >= 2;

foreach my $ws (@workspaces) {
   print "[SELECT] ws# " . $ws . "\n" if $opt->{v} and $opt->{v} > 1;
   docom("workspace $ws");
   docom("move workspace to output ".$opt->{dev});
   docom("rename workspace $ws to t$ws") if $opt->{tempmode};
}

if ( $opt->{tempmode} ) {
   foreach my $ws (@workspaces) {
      docom("workspace t$ws");
      docom("rename workspace t$ws to $ws");
   }
   allmontmp() if $opt->{tempmode} >= 3;
}

exit; # Jojess loves Pandy <3 ----------------------------------------------- #

sub docom {
   my $docom = shift;
   if ( $docom =~ s/^noti3:?// ) {
      system($docom);
      return;
   } else {
      $docom = "i3-msg \"$docom\"";
      print "[DOCOM] $docom\n" if $opt->{v};
      my $dwcom = `$docom` if $opt->{exec};
      select(undef,undef,undef,$opt->{sleepyexec}) if $opt->{sleepyexec}; 
      print $dwcom if $opt->{v} and $opt->{v} > 1;
      return;
   } 
}

sub allmontmp {
   EACHMON: foreach my $mna (grep /mondo/, sort keys %{$opt}) {
      my $mon = $opt->{$mna};
      next EACHMON if ! $mon; 
      my $sfx = substr($mna, -1);
      docom("workspace z$sfx");
      docom("noti3:xterm &") if ! $opt->{allmontmpq};
      docom("move workspace to output $mon");
   }
   $opt->{allmontmpq}++;
   system("killall -15 xterm") if $opt->{allmontmpq} > 1;
}

sub i3monz {
   open IF, "<".$ENV{HOME}."/.config/i3/config";
   LI: while (<IF>) {
     next LI if m/^\s*#/;
     next LI if ! m/set..mondo/;
     s/^set..//;
     my @yarg = split(" ", $_);
     $opt->{$yarg[0]} = $yarg[1];
   }
   close IF;
   foreach my $i ('l', 'r', 'c') { $opt->{dev} //= $opt->{"mondo$i"} if $opt->{$i} }
   $opt->{dev} //= $opt->{mondod};
}

sub darguser { # lazier - `r` ~ `-r=1` ~ `-r`;  `w5` ~ `-w=5`
   my @darg = @{+shift};
   my $opt = shift;
      $opt->{v}    //= 0; # verbose
   foreach my $d (@darg) {
      if ( $d =~ /^([w])(\d{1,2})$/ ) { $opt->{$1} = $2 }
      if ( $d =~ /^([lcr])$/        ) { $opt->{$1} =  1 }
   }
}
