#!/usr/bin/perl
# JAF 20250908

use Getopt::Lazier;
my ($opt,@DARG) = Getopt::Lazier->new(@ARGV);

# requires workspaces t1-t21 be defined alongside ws 1-20 in i3.config~

$opt->{d}    //= "eDP-1"; # target monitor
$opt->{d}      =~ s/^(0|e|d|edp|edp-1)$/eDP-1/i;  # presets for monitors
$opt->{d}      =~ s/^(1)$/DP-2/i;

$opt->{othermon} = "DP-2" if $opt->{d} =~ /eDP-1/;
$opt->{othermon} = "eDP-1" if $opt->{d} =~ /DP-2/;

$opt->{r}    //= "1-20";  # workspaces to move;  e.g.: -r=1,5,7-10 # defaults to 1 through 20
$opt->{tempmode} //= 1;
$opt->{exec} //= 1;
$opt->{sleepyexec} //= 100;
$opt->{sleepyexec}   = $opt->{sleepyexec} / 1000;
$opt->{v}    //= 0;

$opt->{wcom} //= "i3-msg \"workspace WID\"";
$opt->{mcom} //= "i3-msg \"move workspace to output ".$opt->{d}."\"";
$opt->{rcom} //= "i3-msg \"rename workspace WID to tWID\"";
$opt->{rrcom} //= "i3-msg \"rename workspace tWID to WID\"";

my @workspaces = ();

my @ws0 = split(",", $opt->{r});
foreach my $ws1 (@ws0) {
   my @range = split("-", $ws1);
   $range[1] //= $range[0];
   for (my $i=$range[0];$i<=$range[1];$i++) {
      push(@workspaces, $i);
   }
}
foreach my $ws (@workspaces) {
   print "[SELECT] ws# " . $ws . "\n" if $opt->{v} and $opt->{v} > 1;
   
   # (select) workspace WWW
   my $wcom = $opt->{wcom};
   $wcom =~ s/WID/$ws/g;
   print "[WCOM] $wcom\n" if $opt->{v};
   my $twcom = `$wcom` if $opt->{exec};
   select(undef,undef,undef,$opt->{sleepyexec}) if $opt->{sleepyexec};
   print $twcom if $opt->{v} and $opt->{v} > 1;
   
   # move container to output ZZZ
   my $mcom = $opt->{mcom};
   print "[MCOM] $mcom\n" if $opt->{v};
   my $tmcom = `$mcom` if $opt->{exec};
   select(undef,undef,undef,$opt->{sleepyexec}) if $opt->{sleepyexec};
   print $tmcom if $opt->{v} and $opt->{v} > 1;

   if ( $opt->{tempmode} ) {
      # (ToTEMP) 1-20 => t1-t20
      my $rcom = $opt->{rcom};
      $rcom =~ s/WID/$ws/g;
      my $trcom = `$rcom` if $opt->{exec};
      print "[RCOM] $rcom\n" if $opt->{v};
      print $trcom if $opt->{v} and $opt->{v} > 1;

  }
}

if ( $opt->{tempmode} ) {
   # # old monitor t21
   # my $rcom = $opt->{rcom};
   # $rcom =~ s/tWID/t21/g;
   # $rcom =~ s/WID/1/g;
   # print "[t21 RCOM] $rcom\n" if $opt->{v};
   # my $trcom = `$rcom` if $opt->{exec};
   # select(undef,undef,undef,$opt->{sleepyexec}) if $opt->{sleepyexec};
   # print $trcom if $opt->{v} and $opt->{v} > 1;

   foreach my $ws (@workspaces) {
      # (select)  workspace tWWW
      my $wcom = $opt->{wcom};
      $wcom =~ s/WID/t$ws/g;
      print "[WCOM] $wcom\n" if $opt->{v};
      my $twcom = `$wcom` if $opt->{exec};
      print $twcom if $opt->{v} and $opt->{v} > 1;

      # (UNTEMP) t1-20 => 1-20     
      my $rrcom = $opt->{rrcom};
      $rrcom =~ s/WID/$ws/g;
      my $trrcom = `$rrcom` if $opt->{exec};
      print "[RRCOM] $rrcom\n" if $opt->{v};
      print $trrcom if $opt->{v} and $opt->{v} > 1;
   }
}

